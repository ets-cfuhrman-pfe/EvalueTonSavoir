name: E2E Tests on Preprod
on:
  pull_request:
    branches: [ staging ]
  workflow_dispatch:

jobs:
  e2e-tests:
    name: Run E2E Tests Against Preprod
    runs-on: [self-hosted, preprod]
    
    env:
      PREPROD_PATH: ${{ vars.PREPROD_PATH || '/opt/EvalueTonSavoir' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify runner environment
        run: |
          echo "=== Runner Information ==="
          echo "Runner OS: $RUNNER_OS"
          echo "Runner Architecture: $RUNNER_ARCH"
          echo "Runner Name: $RUNNER_NAME"
          echo "Runner Workspace: $RUNNER_WORKSPACE"
          echo "=== System Information ==="
          uname -a
          whoami
          pwd
          echo "=== Docker Information ==="
          docker --version
          docker compose version
      
      - name: Setup test environment with PR code
        run: |
          echo "Setting up test environment with PR code..."
          
          # Create temporary test directory
          TEST_DIR="/tmp/e2e-preprod-${{ github.run_id }}"
          mkdir -p $TEST_DIR
          
          # Copy PR code to test directory
          cp -r ${{ github.workspace }}/. $TEST_DIR/
          
          # Remove hardcoded container names to avoid conflicts with existing preprod
          sed -i '/container_name:/d' $TEST_DIR/docker-compose.yaml
          
          # Remove watchtower services (not needed for testing)
          sed -i '/watchtower:/,/^[^ ]/{ /^[^ ]/!d; /watchtower:/d; }' $TEST_DIR/docker-compose.yaml
          sed -i '/watchtower-once:/,/^[^ ]/{ /^[^ ]/!d; /watchtower-once:/d; }' $TEST_DIR/docker-compose.yaml
          
          # Use different ports to avoid conflicts with existing preprod services
          # Change nginx port from 80 to 10080
          sed -i 's/"80:80"/"10080:80"/g' $TEST_DIR/docker-compose.yaml
          # Change backend port from 3000 to 13000
          sed -i 's/"3000:3000"/"13000:3000"/g' $TEST_DIR/docker-compose.yaml
          # Change frontend port from 5173 to 15173
          sed -i 's/"5173:5173"/"15173:5173"/g' $TEST_DIR/docker-compose.yaml
          # Change keycloak port from 8080 to 18080
          sed -i 's/"8080:8080"/"18080:8080"/g' $TEST_DIR/docker-compose.yaml
          # Remove MongoDB port mapping (not needed for tests)
          sed -i 's/"27017:27017"//g' $TEST_DIR/docker-compose.yaml
          
          # Copy production config files (auth, etc.) if they exist
          if [ -f "${{ env.PREPROD_PATH }}/server/auth_config.json" ]; then
            cp ${{ env.PREPROD_PATH }}/server/auth_config.json $TEST_DIR/server/auth_config.json
          fi
          
          # Build and start services from test directory
          cd $TEST_DIR
          docker compose -p e2e-test-${{ github.run_id }} build --no-cache
          docker compose -p e2e-test-${{ github.run_id }} up -d
          
          # Store test directory path and ports for later steps
          echo "TEST_DIR=$TEST_DIR" >> $GITHUB_ENV
          echo "TEST_PROJECT=e2e-test-${{ github.run_id }}" >> $GITHUB_ENV
          echo "TEST_NGINX_PORT=10080" >> $GITHUB_ENV
          echo "TEST_BACKEND_PORT=13000" >> $GITHUB_ENV
          echo "TEST_FRONTEND_PORT=15173" >> $GITHUB_ENV
          echo "TEST_KEYCLOAK_PORT=18080" >> $GITHUB_ENV
          
          echo "Test environment created at $TEST_DIR"
        
      - name: Copy test files to runner workspace
        run: |
          # Copy the client directory with E2E tests to the runner workspace
          cp -r ${{ github.workspace }}/client /tmp/e2e-client-${{ github.run_id }}
          
      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          
          # Get container names with project prefix
          PROJECT="${{ env.TEST_PROJECT }}"
          
          # Wait for MongoDB to be ready
          if ! timeout 60 bash -c "until docker exec ${PROJECT}-mongo-1 mongosh --eval \"db.runCommand({ping: 1})\" > /dev/null 2>&1; do echo 'Waiting for MongoDB...'; sleep 3; done"; then
            echo "MongoDB failed to start within timeout"
            docker logs ${PROJECT}-mongo-1 --tail 50
            exit 1
          fi
          
          # Wait for backend to be ready (check container health)
          if ! timeout 60 bash -c "until docker inspect ${PROJECT}-backend-1 --format='{{.State.Health.Status}}' 2>/dev/null | grep -q 'healthy\|starting' || docker exec ${PROJECT}-backend-1 curl -f http://localhost:3000/api/health 2>/dev/null; do echo 'Waiting for backend...'; sleep 3; done"; then
            echo "Backend failed to start within timeout"
            docker logs ${PROJECT}-backend-1 --tail 50
            exit 1
          fi
          
          # Wait for frontend to be ready
          if ! timeout 60 bash -c "until docker exec ${PROJECT}-frontend-1 curl -f http://localhost:5173 > /dev/null 2>&1; do echo 'Waiting for frontend...'; sleep 3; done"; then
            echo "Frontend failed to start within timeout"
            docker logs ${PROJECT}-frontend-1 --tail 50
            exit 1
          fi
          
          # Wait for nginx to be ready
          if ! timeout 60 bash -c "until docker exec ${PROJECT}-nginx-1 curl -f http://localhost > /dev/null 2>&1; do echo 'Waiting for nginx...'; sleep 3; done"; then
            echo "Nginx failed to start within timeout"
            docker logs ${PROJECT}-nginx-1 --tail 50
            exit 1
          fi
          
          # Wait for Keycloak to be ready
          if ! timeout 60 bash -c "until docker exec ${PROJECT}-keycloak-1 curl -f http://localhost:8080 > /dev/null 2>&1; do echo 'Waiting for Keycloak...'; sleep 3; done"; then
            echo "Keycloak failed to start within timeout"
            docker logs ${PROJECT}-keycloak-1 --tail 50
            exit 1
          fi
          
          echo "Services status check:"
          docker compose -p ${{ env.TEST_PROJECT }} ps
          
          # Additional wait to ensure all services are fully initialized
          sleep 15
      
      - name: Ensure test user exists
        run: |
          echo "Ensuring test user exists..."
          
          # Get backend container name
          BACKEND_CONTAINER="${{ env.TEST_PROJECT }}-backend-1"
          
          # Try to login with the test user to check if it exists
          LOGIN_RESPONSE=$(docker exec $BACKEND_CONTAINER curl -s -X POST http://localhost:3000/api/auth/simple-auth/login \
            -H "Content-Type: application/json" \
            -d "{\"email\": \"${TEST_USER_EMAIL}\", \"password\": \"${TEST_USER_PASSWORD}\"}")
          
          if echo "$LOGIN_RESPONSE" | grep -q "error\|User not found"; then
            echo "Test user does not exist or login failed. Creating test user..."
            
            # Create the test user via simple auth register
            CREATE_RESPONSE=$(docker exec $BACKEND_CONTAINER curl -s -X POST http://localhost:3000/api/auth/simple-auth/register \
              -H "Content-Type: application/json" \
              -d "{\"email\": \"${TEST_USER_EMAIL}\", \"password\": \"${TEST_USER_PASSWORD}\", \"name\": \"Integration Test Bot\"}")
            
            if echo "$CREATE_RESPONSE" | grep -q "\"message\":\"User created\"\|\"success\":true"; then
              echo "Test user created successfully"
            else
              echo "Failed to create test user: $CREATE_RESPONSE"
              exit 1
            fi
          else
            echo "Test user already exists"
          fi
        env:
          TEST_USER_EMAIL: ${{ secrets.E2E_TEST_USER_EMAIL || secrets.TEST_USER_EMAIL }}  
          TEST_USER_PASSWORD: ${{ secrets.E2E_TEST_USER_PASSWORD || secrets.TEST_USER_PASSWORD }}
      
      - name: Build Playwright test image
        run: |
          cd /tmp/e2e-client-${{ github.run_id }}
          docker build -f Dockerfile.playwright -t evaluetonsavoir-e2e-${{ github.run_id }} .

      - name: Validate E2E secrets
        run: |
          if [ -z "${{ secrets.E2E_TEST_USER_EMAIL }}" ] || [ -z "${{ secrets.E2E_TEST_USER_PASSWORD }}" ]; then
            echo "E2E_TEST_USER_EMAIL or E2E_TEST_USER_PASSWORD secret missing. Please add them to the repo secrets."
            exit 1
          fi
      
      - name: Run Playwright tests in Docker
        run: |
          docker run --rm \
            --add-host host.docker.internal:host-gateway \
            -v /tmp/e2e-client-${{ github.run_id }}/playwright-report:/app/client/playwright-report \
            -v /tmp/e2e-client-${{ github.run_id }}/test-results:/app/client/test-results \
            -e PLAYWRIGHT_BASE_URL=http://host.docker.internal:${{ env.TEST_NGINX_PORT }} \
            -e PLAYWRIGHT_BACKEND_URL=http://host.docker.internal:${{ env.TEST_BACKEND_PORT }} \
            -e PLAYWRIGHT_FRONTEND_URL=http://host.docker.internal:${{ env.TEST_FRONTEND_PORT }} \
            -e PLAYWRIGHT_KEYCLOAK_URL=http://host.docker.internal:${{ env.TEST_KEYCLOAK_PORT }} \
            -e E2E_TEST_USER_EMAIL=${{ secrets.E2E_TEST_USER_EMAIL }} \
            -e E2E_TEST_USER_PASSWORD=${{ secrets.E2E_TEST_USER_PASSWORD }} \
            -e TEST_USER_EMAIL=${{ secrets.E2E_TEST_USER_EMAIL }} \
            -e TEST_USER_PASSWORD=${{ secrets.E2E_TEST_USER_PASSWORD }} \
            -e CI=true \
            evaluetonsavoir-e2e-${{ github.run_id }}
            
      - name: Copy test results back to workspace
        if: always()
        run: |
          mkdir -p ${{ github.workspace }}/client/playwright-report
          mkdir -p ${{ github.workspace }}/client/test-results
          cp -r /tmp/e2e-client-${{ github.run_id }}/playwright-report/* ${{ github.workspace }}/client/playwright-report/ 2>/dev/null || true
          cp -r /tmp/e2e-client-${{ github.run_id }}/test-results/* ${{ github.workspace }}/client/test-results/ 2>/dev/null || true
      
      - name: Show test logs on failure
        if: failure()
        run: |
          echo "=== Docker containers status ==="
          docker compose -p ${{ env.TEST_PROJECT }} ps
          echo "=== Backend logs ==="
          docker logs ${{ env.TEST_PROJECT }}-backend-1 --tail 50
          echo "=== Frontend logs ==="
          docker logs ${{ env.TEST_PROJECT }}-frontend-1 --tail 50
          echo "=== MongoDB logs ==="
          docker logs ${{ env.TEST_PROJECT }}-mongo-1 --tail 20
          echo "=== Nginx logs ==="
          docker logs ${{ env.TEST_PROJECT }}-nginx-1 --tail 20
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: client/playwright-report/
          retention-days: 7
      
      - name: Cleanup test environment
        if: always()
        run: |
          echo "Cleaning up test environment..."
          
          # Stop and remove test containers
          if [ -n "${{ env.TEST_PROJECT }}" ]; then
            docker compose -p ${{ env.TEST_PROJECT }} down -v || true
          fi
          
          # Remove test directory
          if [ -n "${{ env.TEST_DIR }}" ] && [ -d "${{ env.TEST_DIR }}" ]; then
            rm -rf ${{ env.TEST_DIR }}
          fi
          
          # Clean up temporary test files and images
          rm -rf /tmp/e2e-client-${{ github.run_id }} 2>/dev/null || true
          docker rmi evaluetonsavoir-e2e-${{ github.run_id }} 2>/dev/null || true
          
          echo "Test environment cleaned up"