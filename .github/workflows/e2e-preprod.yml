name: E2E Tests on Preprod

on:
  pull_request:
    branches: [ main, staging ]
  workflow_dispatch:

jobs:
  e2e-tests:
    runs-on: [self-hosted, preprod]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Start preprod environment
        run: |
          cd /opt/EvalueTonSavoir
          docker-compose down
          docker-compose pull
          docker-compose up -d --wait
        
      - name: Copy test files to runner workspace
        run: |
          # Copy the client directory with E2E tests to the runner workspace
          cp -r ${{ github.workspace }}/client /tmp/e2e-client-${{ github.run_id }}
          
      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          # Wait for MongoDB to be ready
          timeout 60 bash -c 'until docker exec mongo mongosh --eval "db.runCommand({ping: 1})" > /dev/null 2>&1; do echo "Waiting for MongoDB..."; sleep 3; done' || echo "MongoDB timeout"
          
          # Wait for backend to be ready
          timeout 60 bash -c 'until curl -f http://localhost:3000/health > /dev/null 2>&1 || curl -f http://localhost:3000 > /dev/null 2>&1; do echo "Waiting for backend..."; sleep 3; done' || echo "Backend timeout"
          
          # Wait for frontend to be ready
          timeout 60 bash -c 'until curl -f http://localhost:5173 > /dev/null 2>&1; do echo "Waiting for frontend..."; sleep 3; done' || echo "Frontend timeout"
          
          # Wait for nginx to be ready
          timeout 60 bash -c 'until curl -f http://localhost:80 > /dev/null 2>&1; do echo "Waiting for nginx..."; sleep 3; done' || echo "Nginx timeout"
          
          # Wait for Keycloak to be ready
          timeout 60 bash -c 'until curl -f http://localhost:8080/health/ready > /dev/null 2>&1 || curl -f http://localhost:8080 > /dev/null 2>&1; do echo "Waiting for Keycloak..."; sleep 3; done' || echo "Keycloak timeout"
          
          echo "Services status check:"
          docker-compose -f /opt/EvalueTonSavoir/docker-compose.yaml ps
          
          # Additional wait to ensure all services are fully initialized
          sleep 15
      
      - name: Build Playwright test image
        run: |
          cd /tmp/e2e-client-${{ github.run_id }}
          docker build -f Dockerfile.playwright -t evaluetonsavoir-e2e-${{ github.run_id }} .
      
      - name: Run Playwright tests in Docker
        run: |
          docker run --rm \
            --network host \
            -v /tmp/e2e-client-${{ github.run_id }}/playwright-report:/app/client/playwright-report \
            -v /tmp/e2e-client-${{ github.run_id }}/test-results:/app/client/test-results \
            -e PLAYWRIGHT_BASE_URL=http://localhost:80 \
            -e PLAYWRIGHT_BACKEND_URL=http://localhost:3000 \
            -e PLAYWRIGHT_FRONTEND_URL=http://localhost:5173 \
            -e PLAYWRIGHT_KEYCLOAK_URL=http://localhost:8080 \
            -e CI=true \
            evaluetonsavoir-e2e-${{ github.run_id }}
            
      - name: Copy test results back to workspace
        if: always()
        run: |
          mkdir -p ${{ github.workspace }}/client/playwright-report
          mkdir -p ${{ github.workspace }}/client/test-results
          cp -r /tmp/e2e-client-${{ github.run_id }}/playwright-report/* ${{ github.workspace }}/client/playwright-report/ 2>/dev/null || true
          cp -r /tmp/e2e-client-${{ github.run_id }}/test-results/* ${{ github.workspace }}/client/test-results/ 2>/dev/null || true
      
      - name: Show test logs on failure
        if: failure()
        run: |
          echo "=== Docker containers status ==="
          docker-compose -f /opt/EvalueTonSavoir/docker-compose.yaml ps
          echo "=== Backend logs ==="
          docker logs backend --tail 50
          echo "=== Frontend logs ==="
          docker logs frontend --tail 50
          echo "=== MongoDB logs ==="
          docker logs mongo --tail 20
          echo "=== Nginx logs ==="
          docker logs nginx --tail 20
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: client/playwright-report/
          retention-days: 7
      
      - name: Cleanup
        if: always()
        run: |
          cd /opt/EvalueTonSavoir
          docker-compose down
          # Clean up temporary test files and images
          rm -rf /tmp/e2e-client-${{ github.run_id }}
          docker rmi evaluetonsavoir-e2e-${{ github.run_id }} 2>/dev/null || true